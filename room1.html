<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <title>movie_room</title>
    <link rel="stylesheet" href="style_room.css">
</head>

<body>
    <div class="header">
        <p>ContentsSyncer</p>
        <h1 id="tagname"></h1>
    </div>
    <div class="main">
        <div class="contents">
            <div id="left-contents-wrapper">
                <div id="left-contents">
                    <div class="parent_screen">
                        <div id="screen" class="screen"></div>
                    </div>
                    <div class="url" id="url">
                        <h3>URLを送信してコンテンツを共有しよう</h3>
                        <form onsubmit="return false;">
                            <input type="text" name="confirm" style="width:auto;height:50px;" id="URL">
                            <input type="button" style="width:50px;height:30px;" value="送信" onclick="send_url()">
                        </form>
                        <div id="result_URLsend"></div>
                    </div>
                </div>
            </div>
            <div id="right-contents-wrapper">
                <div id="right-contents">
                    <div class="comment_content" id="comment_content" style="word-wrap:break-word;">
                        <p>コメ1</p>
                    </div>
                    <div class="comment_form" id="comment_form">
                        <form onsubmit="return false;" name="fm">
                            <input type="text" name="name" id="com_text">
                            <input type="button" id="btnsend" name="submit" value="送信" onclick="send_comment()">
                        </form>
                        <div id="result"></div>
                        <input type="button" id="unMute" value="unmute" onclick="unmute()">
                    </div>
                </div>
            </div>
        </div>
        <div id="link">
            <a class="youtube_link" style="font-size:20px;" href="https://www.youtube.com/">youtubeからURLを取得しよう</a>
        </div>
    </div>
    <script>
        var URL_SEND_NEWMOVIE = "http://54.238.75.103/app/backend/insert_url.php";
        var URL_JUDGE_MOVIE_REQUEST = "http://54.238.75.103/app/backend/select_url.php";
        var URL_GET_COMMENT = "http://54.238.75.103/app/backend/insert_url.php";
        var URL_GET_PLAYING_URL = "http://54.238.75.103/app/backend/playing_url.php";
        function URLToId(url) {
            a = url.split("=");
            return a[1];
        }
        function unmute() {
            player.unMute();
        }
        const query = location.search;
        const value = query.split('=');
        var tag = decodeURIComponent(value[1]);//index.htmlからget通信で受け取った変数
        ////console.log("saito:"+"saito:"+tag);
        /*tagが定義されていないとメインページに戻る仕様。開発中は無視しておｋ
        if (tag === "undefined") window.location.href="index.html";
        else  document.getElementById("tagname").innerHTML = tag ;*/
        //API読み込み
        var tt = document.createElement('script');
        tt.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tt, firstScriptTag);

        /////////////////////////////////////////////////////////////////
        
        var response = sendPostXHR(URL_GET_PLAYING_URL, "fill", "hoge",tag);
        console.log(response);
        currentURL = response[0]['url'];
        /////////////////////////////////////////////////////////////////
        var currentURL = "https://www.youtube.com/watch?v=Mw4j4yPsFtg";//test
        var V_id = URLToId(currentURL);
        var player;
        var YoutubeLength;
        var currentTime;
        var nextURL;
        function LoadYoutube(StartTime = 0) {
            player = new YT.Player('screen', {
                videoId: URLToId(currentURL),
                playerVars: {
                    'autoplay': 1,
                    'controls': 0,
                    'disablekb': 1,
                    'iv_load_policy': 3,
                    'rel': 0,
                    'modestbranding': 1,
                    'start': StartTime
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                }
            });
        }
        //APIが読み込まれたら実行される関数。StartTimeを取得して参加
        function onYouTubeIframeAPIReady() {
            ///////////////////////////////////////////////////////////////
            //StartTime = sendPostXHR(/*phpURL*/0, "load_message", true, tag);   //load_message >>> StartTime
            StartTime = 0;
            /////////////////////////////////////////////////////////////////
            LoadYoutube(StartTime);
        }
        function onPlayerReady(event) {
            //ミュートにしてから再生しないといけないらしい
            player.mute();
            event.target.playVideo();//再生
            YoutubeLength = player.getDuration();//動画の長さ
            //console.log("saito:"+YoutubeLength);
        }
        /*player.getPlayerState()
        -1 – 未開始
        0 – 終了
        1 – 再生中
        2 – 一時停止
        3 – バッファリング中
        5 – 頭出し済み
        */
        function onPlayerStateChange(event) {
            if (player.getPlayerState() == 2) {
                event.target.playVideo();
                //止めさせない
            }
            if (player.getPlayerState() == 0) {
                currentURL = nextURL;   //currentURLを更新
                LoadYoutube();     //新しい動画のURLでロード
                //返り値は何でもいい。ここでflagをtrueにする。
                /////////////////////////////////////////////////////////////////
                //var any = sendPostXHR(URL_JUDGE_MOVIE_REQUEST, "current_url", currentURL,tag);　//start_message >> flag=true
                /////////////////////////////////////////////////////////////////
            }
        }
        setInterval(function () {
            currentTime = parseInt(player.getCurrentTime());
            //console.log("saito:"+player.getVideoLoadedFraction());
            //console.log("saito:"+"state" + player.getPlayerState());
            //console.log("saito:"+currentTime + "/" + YoutubeLength);
            //console.log("saito:"+player.getPlaybackRate());
            //返り値は適当でいい。1秒ごとにPOSTで現在の動画時間を送る
            //var any = sendPostXHR(/*phpURL*/0, "currentTime", currentTime);
            //nextURLが更新されていない、かつ、動画の残り時間10秒のとき
            if (nextURL == currentURL && YoutubeLength - currrentTime < 10) {
                var t = new Date();
                var rand = 111 * t.getDate() + t.getHours();
                //乱数を送る
                /////////////////////////////////////////////////////////////////
                //console.log("saito:"+sendPostXHR(URL_JUDGE_MOVIE_REQUEST, "current_url", currentURL,tag));　//start_message >> flag=true
                console.log(tag);
                var response = sendPostXHR(URL_GET_PLAYING_URL, "fill", "hoge",tag);
                console.log(response);
                nextURL = response['url'];
                /////////////////////////////////////////////////////////////////
                //backend側での処理
                //1. 最初に来たエンドメッセージのリクエストでランダムにURLを選定。flag=falseにする。DBのcurrentURLを書き換える
                //2. その後にくるリクエストはflagではじいて、currentURLを返す。
                //3. 次の動画が始まるときにスタートメッセージを送るので、そのときにflag=trueをする.
            }
        }, 1000);


        //post通信
        //ここらへん実際に動くか自信ないので確認お願いします。。。。
        //（送信先のディレクトリ、サーバーで受け取ったときの変数の名前、変数の中身、タグ名）
        /*function sendPostXHR(url,name,data,tag){
            var test = "aaa" ;
            var request = createXmlHttpRequest();
            request.open('POST', url);
            request.addEventListener('load', function (response) {
                test = this.responseText;
                console.log(test);
            });
            request.send();
        }
        function createXmlHttpRequest() { var xmlhttp=null; if(window.ActiveXObject) { try { xmlhttp=new ActiveXObject("Msxml2.XMLHTTP"); } catch(e) { try { xmlhttp = new ActiveXObject("Microsoft.XMLHTTP"); } catch (e2) { } } } else if(window.XMLHttpRequest) { xmlhttp = new XMLHttpRequest(); } return xmlhttp; } 
        */
        function sendPostXHR(url, name, data, tag) {
            var xhr = new XMLHttpRequest();
            var return_data;
            //xhr.withCredentials = true;
            xhr.open('POST', url);
            //tagと任意の変数を渡します。
            var Data = "tag" + "=" + tag + "&" + name + "=" + toString(data);
            xhr.setRequestHeader('content-type', 'application/json');
            xhr.onload = () => {
                console.log("saito:"+xhr.status);
                //console.log("saito:"+"success!");
                return_data = JSON.parse(xhr.responseText);
            };
            xhr.onerror = () => {
                //console.log("saito:"+xhr.status);
                //console.log("saito:"+"error!");
            };
            xhr.send(Data);
            xhr.onreadystatechange = function () {
                switch (xhr.readyState) {
                    case 0:
                        // 未初期化状態.
                        //console.log("saito:"+'uninitialized!');
                        break;
                    case 1: // データ送信中.
                        //console.log("saito:"+'loading...');
                        break;
                    case 2: // 応答待ち.
                        //console.log("saito:"+'loaded.');
                        break;
                    case 3: // データ受信中.
                        //console.log("saito:"+'interactive... ' + xhr.responseText.length + ' bytes.');
                        break;
                    case 4: // データ受信完了.
                        if (xhr.status == 200 || xhr.status == 304) {
                            var data = xhr.responseText; // responseXML もあり
                            //console.log("saito:"+'COMPLETE! :' + data);
                        } else {
                            //console.log("saito:"+'Failed. HttpStatus: ' + xhr.statusText);
                        }
                        break;
                }
                if (xhr.readyState === 4 && xhr.status === 200) {
                    console.log("saito:"+responseData);
                    ///////////////////////////////////
                    return_data = 0;
                    ///////////////////////////////////
                    //return_dataは実際に通信してみて状況に応じて適切な値を返すように設定してほしい
                }
            }
            return return_data;
        }
        function send_url() {
            var sendURL = document.getElementById("URL").value;
            /////////////////////////////////////////////////////////////////
            var message = sendPostXHR(URL_SEND_NEWMOVIE, "urlrequest", sendURL, tag);   //tag>>> URL
            /////////////////////////////////////////////////////////////////
            message = "送信に成功しました.";//test
            document.getElementById("result_URLsend").innerHTML = message;
        }


        //コメントの処理
        function add_comment(text) {
            var newElement = document.createElement("p"); // p要素作成
            var newContent = document.createTextNode(text); // テキストノードを作成
            newElement.appendChild(newContent); // p要素にテキストノードを追加
            newElement.setAttribute("id", "child-p1"); // p要素にidを設定
            var parentDiv = document.getElementById("comment_content");
            parentDiv.insertBefore(newElement, parentDiv.firstChild);
        }
        var conn = new WebSocket('ws://54.238.75.103:8080');
        conn.onopen = function (e) {
            //console.log("saito:"+"Connection established!");
        };
        conn.onmessage = function (e) {
            add_comment(e.data);
        };
        function send_comment() {
            text = document.getElementById("com_text").value;
            document.getElementById("com_text").value = "";
            conn.send(text);
            add_comment(text);
        }
        

    </script>
</body>

</html>
